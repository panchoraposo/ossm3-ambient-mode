- name: Phase 0 - Ensure local Python dependencies for Ansible modules
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    deps:
      - kubernetes
      - openshift
      - PyYAML
      - jmespath
  tasks:
    - name: Install required Python packages (best effort)
      ansible.builtin.command: >-
        {{ ansible_playbook_python }} -m pip install -q {{ deps | join(' ') }}
      register: pip_install
      changed_when: pip_install.rc == 0
      failed_when: false

    - name: Install required Python packages (allow system site-packages)
      when: pip_install.rc != 0
      ansible.builtin.command: >-
        {{ ansible_playbook_python }} -m pip install -q --break-system-packages {{ deps | join(' ') }}

- name: Install demo components (single cluster)
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/demo.yaml
  
  roles:
    - role: gitops-config
    - role: gitops-deploy-odf
    - role: gitops-observability
    - role: service-mesh
    - role: bookinfo-ambient
    - role: connectivity-link