---
  - name: "Create 'kuadrant-system' namespace"
    kubernetes.core.k8s:
      context: "{{ k8s_context | default(omit) }}"
      state: present
      definition:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: kuadrant-system
          labels:
            openshift.io/cluster-monitoring: "true"
  
  - name: "Read mesh root CA from Istio secrets (istio-ca-secret or cacerts)"
    kubernetes.core.k8s_info:
      context: "{{ k8s_context | default(omit) }}"
      api_version: v1
      kind: Secret
      name: "{{ item }}"
      namespace: istio-system
    loop:
      - istio-ca-secret
      - cacerts
    register: istio_ca_secrets
    changed_when: false
    failed_when: false
    retries: 30
    delay: 5
  
  - name: "Set mesh root CA content (PEM)"
    ansible.builtin.set_fact:
      mesh_root_cert_pem: >-
        {%- set sec = (istio_ca_secrets.results | map(attribute='resources') | select('defined') | list) -%}
        {%- set istio_ca = (istio_ca_secrets.results | selectattr('item','equalto','istio-ca-secret') | map(attribute='resources') | first | default([])) -%}
        {%- set cacerts = (istio_ca_secrets.results | selectattr('item','equalto','cacerts') | map(attribute='resources') | first | default([])) -%}
        {%- if istio_ca | length > 0 and (istio_ca[0].data['ca-cert.pem'] is defined) -%}
        {{ istio_ca[0].data['ca-cert.pem'] | b64decode }}
        {%- elif cacerts | length > 0 and (cacerts[0].data['root-cert.pem'] is defined) -%}
        {{ cacerts[0].data['root-cert.pem'] | b64decode }}
        {%- else -%}
        {{ '' }}
        {%- endif -%}

  - name: "Fail if mesh root CA could not be found"
    ansible.builtin.fail:
      msg: >-
        Could not find a mesh root CA in istio-system. Expected Secret/istio-ca-secret (data.ca-cert.pem)
        or Secret/cacerts (data.root-cert.pem). Ensure Phase 1 (shared CA) and Istio installation completed.
    when: mesh_root_cert_pem | length == 0

  - name: "Create 'istio-ca-root-cert' ConfigMap in kuadrant-system"
    kubernetes.core.k8s:
      context: "{{ k8s_context | default(omit) }}"
      state: present
      definition:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: istio-ca-root-cert
          namespace: kuadrant-system
          labels:
            istio.io/config: "true"
        data:
          root-cert.pem: "{{ mesh_root_cert_pem }}"
  
  - name: "Install Connectivity Link operator (OperatorGroup + Subscription)"
    kubernetes.core.k8s:
      context: "{{ k8s_context | default(omit) }}"
      state: present
      src: "{{ item }}"
    loop:
      - "{{ role_path }}/../../../../apps/connectivity-link-operator/base/operator-group.yaml"
      - "{{ role_path }}/../../../../apps/connectivity-link-operator/base/subscription.yaml"

  - name: "Wait for Connectivity Link operator CSV to be Succeeded"
    kubernetes.core.k8s_info:
      context: "{{ k8s_context | default(omit) }}"
      api_version: operators.coreos.com/v1alpha1
      kind: ClusterServiceVersion
      namespace: kuadrant-system
    register: rhcl_csvs
    until: >-
      (
        rhcl_csvs.resources | default([]) |
        selectattr('metadata', 'defined') |
        selectattr('metadata.name', 'defined') |
        selectattr('metadata.name', 'search', 'rhcl-operator') |
        selectattr('status', 'defined') |
        selectattr('status.phase', 'defined') |
        selectattr('status.phase', 'equalto', 'Succeeded') |
        list | length
      ) > 0
    retries: 60
    delay: 10
    changed_when: false
  
  - name: "Approve pending InstallPlans"
    ansible.builtin.shell: |
      for ip in $(oc{{ (' --context ' ~ k8s_context) if (k8s_context is defined) else '' }} get installplan -n kuadrant-system -o jsonpath='{.items[?(@.status.phase=="RequiresApproval")].metadata.name}'); do
        oc{{ (' --context ' ~ k8s_context) if (k8s_context is defined) else '' }} patch installplan $ip -n kuadrant-system --type merge --patch '{"spec":{"approved":true}}'
        echo "Approved: $ip"
      done
    register: approve_cmd
    changed_when: "'Approved' in approve_cmd.stdout"
    retries: 5
    delay: 10
  
  - name: "Wait for Operator Deployments to be created"
    kubernetes.core.k8s_info:
      context: "{{ k8s_context | default(omit) }}"
      api_version: apps/v1
      kind: Deployment
      namespace: kuadrant-system
    register: operator_deployments
    until: 
      - operator_deployments.resources | length > 0
      - operator_deployments.resources | json_query("[?contains(metadata.name, 'dns-operator')]") | length > 0
      - operator_deployments.resources | json_query("[?contains(metadata.name, 'limitador-operator')]") | length > 0
    retries: 60
    delay: 5
  
  - name: "Restart all pods in kuadrant-system"
    ansible.builtin.shell: |
      oc{{ (' --context ' ~ k8s_context) if (k8s_context is defined) else '' }} delete pods --all -n kuadrant-system --ignore-not-found
    ignore_errors: yes
  
  - name: "Wait for Operators to be Healthy (Available)"
    kubernetes.core.k8s_info:
      context: "{{ k8s_context | default(omit) }}"
      api_version: apps/v1
      kind: Deployment
      name: "{{ item }}"
      namespace: kuadrant-system
    register: op_ready
    until:
      - op_ready.resources is defined
      - op_ready.resources | length > 0
      - op_ready.resources[0].status.readyReplicas is defined
      - op_ready.resources[0].status.readyReplicas >= 1
    retries: 60
    delay: 10
    loop:
      - dns-operator-controller-manager
      - limitador-operator-controller-manager
      - kuadrant-operator-controller-manager
  
  - name: "Enable both 'ossmconsole' and 'kuadrant-console-plugin'"
    kubernetes.core.k8s:
      context: "{{ k8s_context | default(omit) }}"
      api_version: operator.openshift.io/v1
      kind: Console
      name: cluster
      state: patched
      definition:
        spec:
          plugins: 
            - "ossmconsole"
            - "kuadrant-console-plugin"

  - name: "Apply Kuadrant CR (Authorino + Limitador) in kuadrant-system"
    vars:
      kuadrant_yaml_url_effective: "{{ kuadrant_yaml_url | default('https://raw.githubusercontent.com/maximilianoPizarro/nfl-wallet-gitops/main/kuadrant.yaml') }}"
    ansible.builtin.shell: |
      set -e
      oc{{ (' --context ' ~ k8s_context) if (k8s_context is defined) else '' }} apply -n kuadrant-system -f {{ kuadrant_yaml_url_effective }}
    changed_when: true
