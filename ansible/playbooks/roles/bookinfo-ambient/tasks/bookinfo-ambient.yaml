---
- name: Label 'ztunnel' namespace for Istio Discovery
  kubernetes.core.k8s:
    state: patched
    kind: Namespace
    name: "{{ ztunnel_ns }}"
    definition:
      metadata:
        labels:
          istio-discovery: enabled

- name: Label 'istio-system' namespace for Istio Discovery
  kubernetes.core.k8s:
    state: patched
    kind: Namespace
    name: "{{ istio_ns }}"
    definition:
      metadata:
        labels:
          istio-discovery: enabled

- name: Restart Istiod (Reload namespace cache)
  kubernetes.core.k8s:
    state: absent
    kind: Pod
    namespace: "{{ istio_ns }}"
    label_selectors:
      - app=istiod

- name: Wait for Istiod to be Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ istio_ns }}"
    label_selectors:
      - app=istiod
  register: istiod_pod
  until: >-
    istiod_pod.resources | length > 0
    and
    istiod_pod.resources[0].status.phase == 'Running'
  retries: 60
  delay: 5

- name: Restart Ztunnel (Reconnect to Istiod with new permissions)
  kubernetes.core.k8s:
    state: absent
    kind: Pod
    namespace: "{{ ztunnel_ns }}"
    label_selectors:
      - app=ztunnel

- name: Wait for Ztunnel to be Ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ ztunnel_ns }}"
    label_selectors:
      - app=ztunnel
  register: ztunnel_pod
  until: >-
    ztunnel_pod.resources | length > 0
    and
    (ztunnel_pod.resources | selectattr('status.phase', 'equalto', 'Running') | list | length) > 0
  retries: 60
  delay: 5

# ==============================================================================
# 3. PREPARACIÓN DEL NAMESPACE BOOKINFO
# ==============================================================================
- name: Create 'bookinfo' Namespace with Ambient Labels
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ app_ns }}"
        labels:
          istio-discovery: enabled
          istio.io/dataplane-mode: ambient

# ==============================================================================
# 4. DESPLIEGUE DE APLICACIÓN
# ==============================================================================
- name: Deploy Bookinfo Base
  kubernetes.core.k8s:
    state: present
    namespace: "{{ app_ns }}"
    src: "{{ bookinfo_yaml }}"

- name: Deploy Bookinfo Versions
  kubernetes.core.k8s:
    state: present
    namespace: "{{ app_ns }}"
    src: "{{ bookinfo_versions_yaml }}"

# ==============================================================================
# 5. ENROLLMENT (REINICIO DE PODS)
# ==============================================================================
- name: Ensure Pods pick up Ambient Mesh (Force Restart)
  kubernetes.core.k8s:
    state: absent
    kind: Pod
    namespace: "{{ app_ns }}"
    label_selectors:
      - "app in (productpage, details, ratings, reviews)"

- name: Wait for Bookinfo Pods to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ app_ns }}"
    label_selectors:
      - app=productpage
  register: pod_status
  until: "pod_status.resources | length > 0 and pod_status.resources[0].status.phase == 'Running'"
  retries: 60
  delay: 5

# ==============================================================================
# 6. Gateway + Route
# ==============================================================================
- name: Create Gateway
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: gateway.networking.k8s.io/v1
      kind: Gateway
      metadata:
        name: bookinfo-gateway
        namespace: "{{ app_ns }}"
        annotations:
          networking.istio.io/service-type: ClusterIP
      spec:
        gatewayClassName: istio
        listeners:
        - name: http
          port: 80
          protocol: HTTP
          allowedRoutes:
            namespaces:
              from: Same

- name: Create HTTPRoute
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata:
        name: bookinfo
        namespace: "{{ app_ns }}"
      spec:
        parentRefs:
        - name: bookinfo-gateway
        rules:
        - matches:
          - path:
              type: PathPrefix
              value: /productpage
          - path:
              type: PathPrefix
              value: /static
          - path:
              type: PathPrefix
              value: /login
          - path:
              type: PathPrefix
              value: /logout
          - path:
              type: PathPrefix
              value: /api/v1/products
          backendRefs:
          - name: productpage
            port: 9080

- name: Get OpenShift Ingress Domain
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Ingress
    name: cluster
  register: ingress_config

- name: Create OpenShift Route
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: route.openshift.io/v1
      kind: Route
      metadata:
        name: bookinfo-gateway
        namespace: "{{ app_ns }}"
      spec:
        host: "bookinfo.{{ ingress_config.resources[0].spec.domain }}"
        to:
          kind: Service
          name: "bookinfo-gateway-istio"
          weight: 100
        port:
          targetPort: 80
        wildcardPolicy: None

- name: Get Route Host
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: bookinfo-gateway
    namespace: bookinfo
  register: route_info

- name: Generate Traffic to create Traces
  uri:
    url: "http://{{ route_info.resources[0].spec.host }}/productpage"
    method: GET
    status_code: 200
  loop: "{{ range(0, 30) | list }}"
  delay: 1
  ignore_errors: yes