apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
  - namespace.yaml
  - per-service-waypoints.yaml
  - podmonitor-waypoints.yaml
  - httproute.yaml
  - route.yaml

patches:
  - target:
      kind: Gateway
      name: bookinfo-gateway
    patch: |-
      apiVersion: gateway.networking.k8s.io/v1
      kind: Gateway
      metadata:
        name: bookinfo-gateway
        annotations:
          networking.istio.io/service-type: ClusterIP

  - target:
      kind: Service
      name: productpage
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: productpage
        labels:
          istio.io/use-waypoint: productpage-waypoint
          istio.io/global: "true"

  - target:
      kind: Service
      name: reviews
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: reviews
        labels:
          istio.io/use-waypoint: reviews-waypoint
          istio.io/global: "true"

  - target:
      kind: Service
      name: ratings
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: ratings
        labels:
          istio.io/use-waypoint: ratings-waypoint
          istio.io/global: "true"

  - target:
      kind: Service
      name: details
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: details
        labels:
          istio.io/use-waypoint: details-waypoint
          istio.io/global: "true"

  # Needed for ingress gateway -> ambient backend HBONE handling
  - target:
      kind: Deployment
      name: productpage-v1
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: productpage-v1
      spec:
        template:
          metadata:
            labels:
              istio.io/use-waypoint: productpage-waypoint

  # Enforce "only Deployments" (no versioned Services). bookinfo.yaml includes these Services.
  - target: { kind: Service, name: details-v1 }
    patch: |-
      apiVersion: v1
      kind: Service
      metadata: { name: details-v1 }
      $patch: delete
  - target: { kind: Service, name: ratings-v1 }
    patch: |-
      apiVersion: v1
      kind: Service
      metadata: { name: ratings-v1 }
      $patch: delete
  - target: { kind: Service, name: productpage-v1 }
    patch: |-
      apiVersion: v1
      kind: Service
      metadata: { name: productpage-v1 }
      $patch: delete
  - target: { kind: Service, name: reviews-v2 }
    patch: |-
      apiVersion: v1
      kind: Service
      metadata: { name: reviews-v2 }
      $patch: delete
  - target: { kind: Service, name: reviews-v3 }
    patch: |-
      apiVersion: v1
      kind: Service
      metadata: { name: reviews-v3 }
      $patch: delete

